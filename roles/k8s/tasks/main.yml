---
# Main tasks

- name: Setup RedHat 7
  include_tasks: redhat7.yml
  when: ansible_os_family|lower == 'redhat' and ansible_distribution_major_version == '7'

- name: Setup Debian 10
  include_tasks: debian10.yml
  when: ansible_os_family|lower == 'debian' and ansible_distribution_major_version == '10'

- name: Setup Debian 11
  include_tasks: debian11.yml
  when: ansible_os_family|lower == 'debian' and ansible_distribution_major_version == '11'

- name: Check Helm version
  shell: helm version --template {% raw %}{{.Version}}{% endraw %}
  register: helm_version_check
  ignore_errors: true
  changed_when: false

- name: Install Helm
  unarchive:
    remote_src: true
    src: https://get.helm.sh/helm-v{{helm_version}}-linux-amd64.tar.gz
    dest: /usr/local/bin
    extra_opts: ["--strip-components=1", "linux-amd64/helm"]
    creates: /usr/local/bin/helm
  when: helm_version_check.rc != 0 or helm_version_check.stdout != ("v" + helm_version)

- name: Check Calico CLI version
  shell: calicoctl version | grep 'Client Version:' | egrep -o 'v[0-9.]+'
  register: calico_version_check
  ignore_errors: true
  changed_when: false

- name: Install Calico CLI
  get_url:
    url: https://github.com/projectcalico/calicoctl/releases/download/v{{calico_version}}/calicoctl
    dest: /usr/local/bin/calicoctl
    mode: 0755
  when: calico_version_check.rc != 0 or calico_version_check.stdout != ("v" + calico_version)

- name: Create containers storage directory
  file:
    path: "{{containers_storage_dir}}"
    mode: 0700
    state: directory

- name: Configure containers storage (runroot)
  lineinfile:
    path: /etc/containers/storage.conf
    regexp: "^runroot = "
    line: "runroot = {{containers_storage_dir}}/run"

- name: Configure containers storage (graphroot)
  lineinfile:
    path: /etc/containers/storage.conf
    regexp: "^graphroot = "
    line: "graphroot = {{containers_storage_dir}}/graph"
